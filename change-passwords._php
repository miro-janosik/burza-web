<?php

	echo "Generujem nove hesla pre vsetkych uzivatelov <br/><br/>\n";

	echo "Pripajam databazu<br/>\n";
  require 'db.php';
	
	echo "Vyberam uzivatelov<br/>\n";
	$query = "SELECT `ID`, `info`, `LoginStr` FROM `Users`";
	
	echo "Pred zmenou:<br/>\n";
  $stmt = mysqli_stmt_init($link);
  if(!mysqli_stmt_prepare($stmt, $query)){
    die("Prepare do databazy neuspesne");
	}else{
		if (!mysqli_stmt_execute($stmt))
		{
			die("Execute do databazy neuspesne!");
		}
		$users = dbGetAllRowsArrayOfArrays($stmt);
		foreach($users AS $user) {
			echo($user['ID'] .";". $user["info"] . ";" . $user["LoginStr"] ."<br/>\n");
		}
	}
	
	echo "Zapisujem nove kody: <br/>\n";
	foreach($users AS $user) {
		$pwd = "";
		$characters = 'ABCDEFGHIJKLMNPRSTUWXYZ';
		for ($i = 0; $i < 3; $i++) {
			$index = rand(0, strlen($characters) - 1);
			$pwd .= $characters[$index];
		}
		
		$user["LoginStr"] = $user["info"] . "-" . $pwd;
		
		echo($user['ID'] .";". $user["info"] . ";" . $user["LoginStr"] ."<br/>\n");
		
		$query = "UPDATE `Users` SET `LoginStr` = '". $user["LoginStr"] ."' WHERE `ID` = '". $user['ID'] ."'";
		if(!mysqli_stmt_prepare($stmt, $query)){
			echo $query . " ...";
			die("Prepare do databazy neuspesne!");
		}
		if (!mysqli_stmt_execute($stmt))
		{
			die("Execute do databazy neuspesne!");
		}
	}
	
	echo "Zmeny ukoncene<br/>\n";
	
	die();

?>
